<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Multi-Asset Split Risk & Margin Tool</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg: #0f172a;
      --card-bg: #020617;
      --text: #e5e7eb;
      --muted: #9ca3af;
      --border: #1f2937;
      --input-bg: #020617;
      --input-border: #374151;
      --accent: #facc15;
      --accent-2: #f97316;
      --positive: #4ade80;
      --negative: #f97373;
    }
    body[data-theme="light"] {
      --bg: #f3f4f6;
      --card-bg: #ffffff;
      --text: #111827;
      --muted: #6b7280;
      --border: #e5e7eb;
      --input-bg: #ffffff;
      --input-border: #d1d5db;
      --accent: #f59e0b;
      --accent-2: #f97316;
      --positive: #16a34a;
      --negative: #dc2626;
    }
    * { box-sizing: border-box; }
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont,
        "Segoe UI", sans-serif;
      background: var(--bg);
      color: var(--text);
      margin: 0;
      padding: 0;
      display: flex;
      justify-content: center;
      min-height: 100vh;
    }
    .app {
      background: var(--card-bg);
      border-radius: 18px;
      padding: 18px 18px 22px;
      margin: 16px;
      width: 100%;
      max-width: 520px;
      box-shadow: 0 18px 35px rgba(15, 23, 42, 0.4);
      border: 1px solid var(--border);
    }
    @media (min-width: 600px) {
      .app { padding: 22px 22px 26px; }
    }
    .app-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      margin-bottom: 8px;
    }
    h1 {
      margin: 0;
      font-size: 1.1rem;
      color: var(--accent);
    }
    .subtitle {
      font-size: 0.8rem;
      color: var(--muted);
      margin-bottom: 10px;
    }

    .theme-switch {
      width: 46px;
      height: 26px;
      border-radius: 999px;
      background: var(--input-border);
      position: relative;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 5px;
      cursor: pointer;
      box-shadow: 0 4px 10px rgba(0,0,0,0.35);
      transition: background 0.15s ease, box-shadow 0.15s ease, transform 0.08s ease;
      font-size: 0.78rem;
      color: var(--muted);
    }
    .theme-switch:hover {
      transform: translateY(-1px);
      box-shadow: 0 6px 14px rgba(0,0,0,0.45);
    }
    .theme-thumb {
      position: absolute;
      top: 2px;
      left: 2px;
      width: 22px;
      height: 22px;
      border-radius: 999px;
      background: #ffffff;
      transition: transform 0.16s ease;
    }
    .theme-icon {
      z-index: 1;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    body[data-theme="dark"] .icon-moon { color: #ffffff; }
    body[data-theme="dark"] .icon-sun { color: var(--muted); }
    body[data-theme="light"] .icon-sun { color: #111827; }
    body[data-theme="light"] .icon-moon { color: var(--muted); }
    body[data-theme="light"] .theme-switch { background: var(--accent); }
    body[data-theme="light"] .theme-thumb { transform: translateX(18px); }

    .section-title {
      font-size: 0.8rem;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      color: var(--muted);
      margin: 12px 0 6px;
    }
    .field-group { margin-bottom: 10px; }
    label {
      display: flex;
      justify-content: space-between;
      font-size: 0.8rem;
      margin-bottom: 3px;
    }
    .hint {
      color: var(--muted);
      margin-left: 4px;
      font-size: 0.72rem;
    }
    input[type="number"],
    input[type="text"],
    select {
      width: 100%;
      padding: 6px 8px;
      border-radius: 9px;
      border: 1px solid var(--input-border);
      background: var(--input-bg);
      color: var(--text);
      font-size: 0.82rem;
    }
    input[type="number"]:focus,
    input[type="text"]:focus,
    select:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 1px rgba(250, 204, 21, 0.4);
    }
    input[readonly] {
      background: rgba(148,163,184,0.08);
      cursor: default;
    }
    .row-2 {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
    }
    .row-3 {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 8px;
    }
    .side-options {
      display: flex;
      gap: 8px;
      font-size: 0.78rem;
    }
    .side-option {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 3px 8px;
      border-radius: 999px;
      border: 1px solid var(--input-border);
      cursor: pointer;
      user-select: none;
    }
    .side-option input { accent-color: var(--accent); }

    .btn-row {
      display: flex;
      gap: 8px;
      margin-top: 6px;
      margin-bottom: 10px;
      flex-wrap: wrap;
    }
    button {
      flex: 1;
      padding: 7px 10px;
      border-radius: 999px;
      border: none;
      font-size: 0.8rem;
      font-weight: 600;
      cursor: pointer;
      background: linear-gradient(135deg, var(--accent), var(--accent-2));
      color: #111827;
      transition: transform 0.08s ease, box-shadow 0.08s ease, opacity 0.08s ease;
      white-space: nowrap;
    }
    button.secondary {
      background: transparent;
      color: var(--text);
      border: 1px solid var(--input-border);
    }
    button:hover {
      transform: translateY(-1px);
      box-shadow: 0 8px 16px rgba(0,0,0,0.45);
    }
    button:active {
      transform: translateY(0);
      box-shadow: none;
      opacity: 0.9;
    }

    .results {
      margin-top: 10px;
      border-top: 1px solid var(--border);
      padding-top: 10px;
    }
    .results h2 {
      font-size: 0.9rem;
      margin: 0 0 6px;
    }
    .result-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 6px 10px;
      font-size: 0.8rem;
    }
    .result-item {
      display: flex;
      justify-content: space-between;
      gap: 4px;
    }
    .result-label { color: var(--muted); }
    .result-value {
      font-weight: 600;
      text-align: right;
    }
    .positive { color: var(--positive); }
    .negative { color: var(--negative); }

    .note {
      margin-top: 6px;
      font-size: 0.72rem;
      color: var(--muted);
      line-height: 1.3;
    }

    .split-block {
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 8px 10px;
      margin-bottom: 8px;
      background: rgba(15,23,42,0.3);
    }
    body[data-theme="light"] .split-block {
      background: #f9fafb;
    }
    .split-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 6px;
      font-size: 0.8rem;
      color: var(--muted);
    }
    .split-auto {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      font-size: 0.75rem;
      cursor: pointer;
    }
    .split-auto input { accent-color: var(--accent); }
    .lot-pct-row { margin-bottom: 6px; }

    .pos-block {
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 6px 8px 8px;
      margin-bottom: 6px;
      background: rgba(15,23,42,0.18);
    }
    body[data-theme="light"] .pos-block {
      background: #f9fafb;
    }
    .pos-title {
      font-size: 0.76rem;
      font-weight: 600;
      color: var(--muted);
      margin-bottom: 4px;
    }
  </style>
</head>
<body data-theme="dark">
  <div class="app">
    <div class="app-header">
      <div>
        <h1>Multi-Asset Split Risk Tool</h1>
        <div class="subtitle">
          XAU / FX / indices / crypto – split entries, risk %, SL/TP, R:R, margin
        </div>
      </div>
      <div class="theme-switch" id="themeToggle">
        <span class="theme-icon icon-moon">
          <svg viewBox="0 0 24 24" width="14" height="14"
               fill="none" stroke="currentColor" stroke-width="1.8"
               stroke-linecap="round" stroke-linejoin="round">
            <path d="M21 12.79A9 9 0 0 1 11.21 3
                     7 7 0 1 0 21 12.79z"/>
          </svg>
        </span>
        <span class="theme-icon icon-sun">
          <svg viewBox="0 0 24 24" width="14" height="14"
               fill="none" stroke="currentColor" stroke-width="1.8"
               stroke-linecap="round" stroke-linejoin="round">
            <circle cx="12" cy="12" r="4"/>
            <line x1="12" y1="2" x2="12" y2="4"/>
            <line x1="12" y1="20" x2="12" y2="22"/>
            <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/>
            <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/>
            <line x1="2" y1="12" x2="4" y2="12"/>
            <line x1="20" y1="12" x2="22" y2="12"/>
            <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/>
            <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/>
          </svg>
        </span>
        <span class="theme-thumb"></span>
      </div>
    </div>

    <!-- Account & Risk -->
    <div class="section-title">Account & Risk</div>
    <div class="field-group row-2">
      <div>
        <label>Account Balance</label>
        <input type="number" id="balance" value="1500" step="0.01">
      </div>
      <div>
        <label>Risk % / Trade <span class="hint">e.g. 1–2</span></label>
        <input type="number" id="riskPct" value="1" step="0.1">
      </div>
    </div>
    <div class="field-group row-3">
      <div>
        <label>Leverage</label>
        <input type="number" id="leverage" value="1000" step="1">
      </div>
      <div>
        <label>Margin Call %</label>
        <input type="number" id="marginCall" value="100" step="1">
      </div>
      <div>
        <label>Contract / Lot</label>
        <input type="number" id="contractSize" value="100" step="1">
        <div class="hint" style="margin-top:3px;">auto from symbol, editable</div>
      </div>
    </div>
    <div class="field-group">
      <label>Symbol <span class="hint">XAUUSD, NAS100, BTCUSD, DOGEUSD, etc.</span></label>
      <input type="text" id="symbol" placeholder="XAUUSD">
    </div>

    <!-- Position 1 -->
    <div class="section-title" id="positionBaseTitle">Position</div>
    <div class="field-group">
      <label>Order Type</label>
      <div class="side-options">
        <label class="side-option">
          <input type="radio" name="side" value="buy" checked>
          <span>Buy</span>
        </label>
        <label class="side-option">
          <input type="radio" name="side" value="sell">
          <span>Sell</span>
        </label>
      </div>
    </div>
    <div class="field-group row-2">
      <div>
        <label>Entry Price</label>
        <input type="number" id="entryPrice" value="2000" step="0.01">
      </div>
      <div>
        <label>Current Price</label>
        <input type="number" id="currentPrice" value="1995" step="0.01">
      </div>
    </div>
    <div class="field-group row-2">
      <div>
        <label>Stop Loss Price</label>
        <input type="number" id="slPrice" step="0.01">
        <div class="hint" style="margin-top:3px;">
          Leave empty for auto-SL (Risk% + Lot)
        </div>
      </div>
      <div>
        <label>Take Profit Price</label>
        <input type="number" id="tpPrice" step="0.01">
      </div>
    </div>
    <div class="field-group">
      <label>
        Target R:R (Reward / Risk)
        <span class="hint">auto-calc TP from SL</span>
      </label>
      <input type="number" id="rrInput" step="0.1" placeholder="2.0">
    </div>
    <div class="field-group">
      <label>
        Total Lot Size
        <span class="hint">for all split positions combined</span>
      </label>
      <input type="number" id="lotTotal" value="0.50" step="0.01">
    </div>

    <!-- Split Mode -->
    <div class="section-title">Split Position Mode</div>
    <div class="field-group row-2">
      <div>
        <label>Number of Positions</label>
        <select id="positionCount">
          <option value="1">Off</option>
          <option value="2">2 Positions</option>
          <option value="3">3 Positions</option>
        </select>
      </div>
      <div>
        <label class="hint" style="justify-content:flex-start;margin-top:16px;">
          Use splits for laddered entries
        </label>
      </div>
    </div>

    <div class="field-group row-3 lot-pct-row" id="lotPctRow" style="display:none;">
      <div>
        <label>Lot % Pos 1</label>
        <input type="number" id="lotPct1" value="100" step="1" readonly>
      </div>
      <div>
        <label>Lot % Pos 2</label>
        <input type="number" id="lotPct2" value="0" step="1">
      </div>
      <div>
        <label>Lot % Pos 3</label>
        <input type="number" id="lotPct3" value="0" step="1">
      </div>
    </div>
    <div class="hint" id="lotPctHint"
         style="display:none;margin-top:-4px;margin-bottom:6px;">
      Lot % always sum to 100. Pos 1 adjusts when you change Pos 2 &amp; 3.
    </div>

    <div id="splitBlock" style="display:none;margin-top:4px;">
      <!-- Position 2 block -->
      <div class="split-block" id="pos2Block">
        <div class="split-header">
          <span>Position 2</span>
          <label class="split-auto">
            <input type="checkbox" id="autoEntry2">
            <span>Auto entry from remaining risk</span>
          </label>
        </div>
        <div class="row-2">
          <div>
            <label>Entry 2</label>
            <input type="number" id="entryPrice2" step="0.01">
          </div>
          <div>
            <label>SL 2</label>
            <input type="number" id="slPrice2" step="0.01">
          </div>
        </div>
        <div class="row-2">
          <div>
            <label>TP 2</label>
            <input type="number" id="tpPrice2" step="0.01">
          </div>
          <div>
            <label class="hint" style="justify-content:flex-start;margin-top:18px;">
              SL/TP copy &amp; lock when auto
            </label>
          </div>
        </div>
      </div>

      <!-- Position 3 block -->
      <div class="split-block" id="pos3Block">
        <div class="split-header">
          <span>Position 3</span>
          <label class="split-auto">
            <input type="checkbox" id="autoEntry3">
            <span>Auto entry from remaining risk</span>
          </label>
        </div>
        <div class="row-2">
          <div>
            <label>Entry 3</label>
            <input type="number" id="entryPrice3" step="0.01">
          </div>
          <div>
            <label>SL 3</label>
            <input type="number" id="slPrice3" step="0.01">
          </div>
        </div>
        <div class="row-2">
          <div>
            <label>TP 3</label>
            <input type="number" id="tpPrice3" step="0.01">
          </div>
          <div>
            <label class="hint" style="justify-content:flex-start;margin-top:18px;">
              SL/TP copy &amp; lock when auto
            </label>
          </div>
        </div>
      </div>
    </div>

    <!-- Buttons -->
    <div class="btn-row">
      <button type="button" onclick="suggestFromRisk()">
        Suggest Lot / SL from Risk %
      </button>
      <button type="button" class="secondary" onclick="resetAll()">
        Reset
      </button>
    </div>

    <!-- Results -->
    <div class="results">
      <h2>Results</h2>
      <div class="result-grid">
        <div class="result-item">
          <span class="result-label">Risk Amount (Total):</span>
          <span class="result-value" id="riskAmount">$0.00</span>
        </div>
        <div class="result-item">
          <span class="result-label">Suggested Lot (Total):</span>
          <span class="result-value" id="suggestedLot">0.00</span>
        </div>

        <div class="result-item">
          <span class="result-label">Total Required Margin:</span>
          <span class="result-value" id="marginRequired">$0.00</span>
        </div>
        <div class="result-item">
          <span class="result-label">Total Current P/L:</span>
          <span class="result-value" id="currentPL">$0.00</span>
        </div>

        <div class="result-item">
          <span class="result-label">Total SL P/L:</span>
          <span class="result-value" id="slPL">$0.00</span>
        </div>
        <div class="result-item">
          <span class="result-label">Total TP P/L:</span>
          <span class="result-value" id="tpPL">$0.00</span>
        </div>

        <div class="result-item">
          <span class="result-label">R:R (Reward : Risk):</span>
          <span class="result-value" id="rrRatio">1 : 0.00</span>
        </div>
        <div class="result-item">
          <span class="result-label">Price Move to Margin Call:</span>
          <span class="result-value" id="priceMove">0.000</span>
        </div>
        <div class="result-item">
          <span class="result-label">Margin Call Price:</span>
          <span class="result-value" id="marginCallPrice">0.00</span>
        </div>
      </div>

      <div class="section-title" style="margin-top:10px;">
        Per-Position Breakdown
      </div>

      <!-- Position 1 Results -->
      <div class="pos-block">
        <div class="pos-title">Position 1</div>
        <div class="result-grid">
          <div class="result-item">
            <span class="result-label">Lot:</span>
            <span class="result-value" id="lot1Disp">0.00</span>
          </div>
          <div class="result-item">
            <span class="result-label">Margin:</span>
            <span class="result-value" id="margin1">$0.00</span>
          </div>
          <div class="result-item">
            <span class="result-label">P/L Now:</span>
            <span class="result-value" id="pl1">$0.00</span>
          </div>
          <div class="result-item">
            <span class="result-label">SL P/L:</span>
            <span class="result-value" id="sl1">$0.00</span>
          </div>
          <div class="result-item">
            <span class="result-label">TP P/L:</span>
            <span class="result-value" id="tp1">$0.00</span>
          </div>
          <div class="result-item">
            <span class="result-label">R:R:</span>
            <span class="result-value" id="rr1">1 : 0.00</span>
          </div>
        </div>
      </div>

      <!-- Position 2 Results -->
      <div class="pos-block">
        <div class="pos-title">Position 2</div>
        <div class="result-grid">
          <div class="result-item">
            <span class="result-label">Lot:</span>
            <span class="result-value" id="lot2Disp">0.00</span>
          </div>
          <div class="result-item">
            <span class="result-label">Margin:</span>
            <span class="result-value" id="margin2">$0.00</span>
          </div>
          <div class="result-item">
            <span class="result-label">P/L Now:</span>
            <span class="result-value" id="pl2">$0.00</span>
          </div>
          <div class="result-item">
            <span class="result-label">SL P/L:</span>
            <span class="result-value" id="sl2">$0.00</span>
          </div>
          <div class="result-item">
            <span class="result-label">TP P/L:</span>
            <span class="result-value" id="tp2">$0.00</span>
          </div>
          <div class="result-item">
            <span class="result-label">R:R:</span>
            <span class="result-value" id="rr2">1 : 0.00</span>
          </div>
        </div>
      </div>

      <!-- Position 3 Results -->
      <div class="pos-block">
        <div class="pos-title">Position 3</div>
        <div class="result-grid">
          <div class="result-item">
            <span class="result-label">Lot:</span>
            <span class="result-value" id="lot3Disp">0.00</span>
          </div>
          <div class="result-item">
            <span class="result-label">Margin:</span>
            <span class="result-value" id="margin3">$0.00</span>
          </div>
          <div class="result-item">
            <span class="result-label">P/L Now:</span>
            <span class="result-value" id="pl3">$0.00</span>
          </div>
          <div class="result-item">
            <span class="result-label">SL P/L:</span>
            <span class="result-value" id="sl3">$0.00</span>
          </div>
          <div class="result-item">
            <span class="result-label">TP P/L:</span>
            <span class="result-value" id="tp3">$0.00</span>
          </div>
          <div class="result-item">
            <span class="result-label">R:R:</span>
            <span class="result-value" id="rr3">1 : 0.00</span>
          </div>
        </div>
      </div>

      <div class="note">
        • Total lot is split by Lot % 1–3. Pos 1’s % is locked at (100 − Pos 2 − Pos 3).<br>
        • When “Auto entry from remaining risk” is ON, Entry is calculated from unused risk and SL for that position; SL/TP copy from Position 1 and become locked.<br>
        • “Suggest Lot / SL from Risk %”: if SL is empty, it calculates SL from Risk% + total lot. If SL is set, it calculates total lot from Risk% + SL distance.<br>
        • RR input auto-calculates TP from SL & Entry for Position 1 (R:R in price terms).<br>
        • Contract presets are generic – always double-check with your broker.
      </div>
    </div>
  </div>

  <script>
    const STORAGE_KEY = "multi_asset_split_risk_v7";

    function formatMoney(v){
      if(!isFinite(v)) return "$0.00";
      return "$" + v.toFixed(2);
    }
    function formatNumber(v, d=2){
      if(!isFinite(v)) return "0.00";
      return v.toFixed(d);
    }

    function getSide(){
      const r = document.querySelector('input[name="side"]:checked');
      return r ? r.value : "buy";
    }

    function applyTheme(theme){
      document.body.setAttribute("data-theme", theme);
    }
    function toggleTheme(){
      const cur = document.body.getAttribute("data-theme") || "dark";
      applyTheme(cur === "dark" ? "light" : "dark");
      saveSettings();
    }

    function getAutoContractSize(symRaw){
      if(!symRaw) return null;
      const s = symRaw.trim().toUpperCase();
      if(!s) return null;

      const fx = ["EUR","GBP","AUD","NZD","USD","CAD","CHF","JPY"];

      if(s.startsWith("XAU")) return 100;
      if(s.startsWith("XAG")) return 5000;
      if(s === "USOIL" || s === "UKOIL") return 100;

      const idx = {
        "NAS100":1,"US30":1,"SPX500":1,"GER40":1,"UK100":1,"JP225":1
      };
      if(idx[s]) return idx[s];

      const cryptoBases = ["BTC","ETH","LTC","XRP","ADA","DOGE","SOL","DOT","BNB"];
      const base3 = s.slice(0,3);
      const base4 = s.slice(0,4);
      if(cryptoBases.includes(base3) || cryptoBases.includes(base4)) return 1;

      if(s.length === 6){
        const base = s.slice(0,3), quote = s.slice(3,6);
        if(fx.includes(base) && fx.includes(quote)) return 100000;
      }
      return null;
    }

    function maybeApplyContractPreset(){
      const symEl = document.getElementById("symbol");
      const csEl = document.getElementById("contractSize");
      if(!symEl || !csEl) return;
      const size = getAutoContractSize(symEl.value);
      if(size != null) csEl.value = size;
    }

    function updatePositionTitle(){
      const count = parseInt(document.getElementById("positionCount").value, 10) || 1;
      const titleEl = document.getElementById("positionBaseTitle");
      if(!titleEl) return;
      if(count === 1){
        titleEl.textContent = "Position";
      } else {
        titleEl.textContent = "Position 1 (Base)";
      }
    }

    function applySplitVisibility(){
      const count = parseInt(document.getElementById("positionCount").value, 10) || 1;
      const splitBlock = document.getElementById("splitBlock");
      const pos2 = document.getElementById("pos2Block");
      const pos3 = document.getElementById("pos3Block");
      const lotRow = document.getElementById("lotPctRow");
      const lotHint = document.getElementById("lotPctHint");

      if(count === 1){
        splitBlock.style.display = "none";
        lotRow.style.display = "none";
        lotHint.style.display = "none";
      } else if(count === 2){
        splitBlock.style.display = "block";
        pos2.style.display = "block";
        pos3.style.display = "none";
        lotRow.style.display = "grid";
        lotHint.style.display = "block";
        document.getElementById("lotPct3").value = 0;
        recalcLotPctFromInputs();
      } else {
        splitBlock.style.display = "block";
        pos2.style.display = "block";
        pos3.style.display = "block";
        lotRow.style.display = "grid";
        lotHint.style.display = "block";
        recalcLotPctFromInputs();
      }
      updatePositionTitle();
    }

    function recalcLotPctFromInputs(changedId){
      const count = parseInt(document.getElementById("positionCount").value, 10) || 1;
      const p1El = document.getElementById("lotPct1");
      const p2El = document.getElementById("lotPct2");
      const p3El = document.getElementById("lotPct3");

      let p2 = parseFloat(p2El.value) || 0;
      let p3 = parseFloat(p3El.value) || 0;

      if(count === 1){
        p1El.value = 100;
        p2El.value = 0;
        p3El.value = 0;
        return;
      }

      if(count === 2){
        if(changedId === "lotPct2"){
          p2 = Math.max(0, Math.min(100, p2));
          p2El.value = p2;
        } else {
          p2 = parseFloat(p2El.value) || 0;
        }
        let p1 = 100 - p2;
        if(p1 < 0){
          p1 = 0;
          p2 = 100;
          p2El.value = 100;
        }
        p1El.value = p1;
        p3El.value = 0;
      } else if(count === 3){
        if(changedId === "lotPct2"){
          p2 = Math.max(0, Math.min(100, p2));
          if(p2 + p3 > 100){
            p3 = 100 - p2;
            if(p3 < 0) p3 = 0;
            p3El.value = p3;
          }
          p2El.value = p2;
        } else if(changedId === "lotPct3"){
          p3 = Math.max(0, Math.min(100, p3));
          if(p2 + p3 > 100){
            p2 = 100 - p3;
            if(p2 < 0) p2 = 0;
            p2El.value = p2;
          }
          p3El.value = p3;
        }
        const sum23 = p2 + p3;
        let p1 = 100 - sum23;
        if(p1 < 0) p1 = 0;
        p1El.value = p1;
      }
    }

    function applyAutoEntryState(index){
      const autoEl = document.getElementById("autoEntry" + index);
      const entryEl = document.getElementById("entryPrice" + index);
      const slEl = document.getElementById("slPrice" + index);
      const tpEl = document.getElementById("tpPrice" + index);
      if(!autoEl || !entryEl || !slEl || !tpEl) return;

      const isAuto = autoEl.checked;
      if(isAuto){
        const mainSL = document.getElementById("slPrice").value;
        const mainTP = document.getElementById("tpPrice").value;
        if(!slEl.value && mainSL !== "") slEl.value = mainSL;
        if(!tpEl.value && mainTP !== "") tpEl.value = mainTP;
        entryEl.readOnly = true;
        slEl.readOnly = true;
        tpEl.readOnly = true;
        entryEl.style.opacity = "0.6";
        slEl.style.opacity = "0.6";
        tpEl.style.opacity = "0.6";
      } else {
        entryEl.readOnly = false;
        slEl.readOnly = false;
        tpEl.readOnly = false;
        entryEl.style.opacity = "";
        slEl.style.opacity = "";
        tpEl.style.opacity = "";
      }
    }

    function saveSettings(){
      const data = {
        theme: document.body.getAttribute("data-theme") || "dark",
        balance: document.getElementById("balance").value,
        riskPct: document.getElementById("riskPct").value,
        leverage: document.getElementById("leverage").value,
        marginCall: document.getElementById("marginCall").value,
        contractSize: document.getElementById("contractSize").value,
        symbol: document.getElementById("symbol").value,
        side: getSide(),
        entryPrice: document.getElementById("entryPrice").value,
        currentPrice: document.getElementById("currentPrice").value,
        slPrice: document.getElementById("slPrice").value,
        tpPrice: document.getElementById("tpPrice").value,
        rrInput: document.getElementById("rrInput").value,
        lotTotal: document.getElementById("lotTotal").value,
        positionCount: document.getElementById("positionCount").value,
        lotPct1: document.getElementById("lotPct1").value,
        lotPct2: document.getElementById("lotPct2").value,
        lotPct3: document.getElementById("lotPct3").value,
        entryPrice2: document.getElementById("entryPrice2").value,
        slPrice2: document.getElementById("slPrice2").value,
        tpPrice2: document.getElementById("tpPrice2").value,
        autoEntry2: document.getElementById("autoEntry2").checked,
        entryPrice3: document.getElementById("entryPrice3").value,
        slPrice3: document.getElementById("slPrice3").value,
        tpPrice3: document.getElementById("tpPrice3").value,
        autoEntry3: document.getElementById("autoEntry3").checked
      };
      try {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
      } catch(e){}
    }

    function loadSettings(){
      try{
        const raw = localStorage.getItem(STORAGE_KEY);
        if(!raw){
          applyTheme("dark");
          applySplitVisibility();
          return;
        }
        const d = JSON.parse(raw);
        if(d.theme) applyTheme(d.theme); else applyTheme("dark");

        const ids = [
          "balance","riskPct","leverage","marginCall","contractSize","symbol",
          "entryPrice","currentPrice","slPrice","tpPrice","rrInput","lotTotal",
          "positionCount","lotPct1","lotPct2","lotPct3",
          "entryPrice2","slPrice2","tpPrice2",
          "entryPrice3","slPrice3","tpPrice3"
        ];
        ids.forEach(id => {
          if(d[id] !== undefined && document.getElementById(id)){
            document.getElementById(id).value = d[id];
          }
        });

        if(d.side){
          const r = document.querySelector(
            'input[name="side"][value="' + d.side + '"]'
          );
          if(r) r.checked = true;
        }
        if(typeof d.autoEntry2 === "boolean")
          document.getElementById("autoEntry2").checked = d.autoEntry2;
        if(typeof d.autoEntry3 === "boolean")
          document.getElementById("autoEntry3").checked = d.autoEntry3;

      } catch(e){
        applyTheme("dark");
      }

      applySplitVisibility();
      recalcLotPctFromInputs();
      applyAutoEntryState(2);
      applyAutoEntryState(3);
      updatePositionTitle();
    }

    function suggestFromRisk(){
      const balance = parseFloat(document.getElementById("balance").value) || 0;
      const riskPct = parseFloat(document.getElementById("riskPct").value) || 0;
      const entry = parseFloat(document.getElementById("entryPrice").value) || 0;
      const slVal = parseFloat(document.getElementById("slPrice").value);
      const contractSize = parseFloat(document.getElementById("contractSize").value) || 100;
      const side = getSide();
      const riskAmount = balance * (riskPct / 100);
      const slHas = !isNaN(slVal) && slVal !== 0;
      const lotTotalEl = document.getElementById("lotTotal");
      let lotTotal = parseFloat(lotTotalEl.value) || 0;

      if(!slHas && entry > 0 && lotTotal > 0 && contractSize > 0){
        const units = contractSize * lotTotal;
        const distance = riskAmount / units;
        let slPrice = entry;
        if(side === "buy") slPrice = entry - distance;
        else slPrice = entry + distance;

        document.getElementById("slPrice").value = slPrice.toFixed(2);
        document.getElementById("riskAmount").textContent = formatMoney(riskAmount);
        document.getElementById("suggestedLot").textContent = formatNumber(lotTotal,3);
        saveSettings();
        calculate();
        return;
      }

      const sl = isNaN(slVal) ? 0 : slVal;
      const distance = Math.abs(entry - sl);
      let suggestedLot = 0;
      if(distance > 0 && contractSize > 0){
        const units = riskAmount / distance;
        suggestedLot = units / contractSize;
      }

      lotTotalEl.value = suggestedLot.toFixed(2);
      document.getElementById("riskAmount").textContent = formatMoney(riskAmount);
      document.getElementById("suggestedLot").textContent = formatNumber(suggestedLot,3);
      saveSettings();
      calculate();
    }

    function calculate(){
      const balance = parseFloat(document.getElementById("balance").value) || 0;
      const riskPct = parseFloat(document.getElementById("riskPct").value) || 0;
      const leverage = parseFloat(document.getElementById("leverage").value) || 1;
      const marginCallPct = parseFloat(document.getElementById("marginCall").value) || 0;
      const contractSize = parseFloat(document.getElementById("contractSize").value) || 100;
      const side = getSide();
      const currentPrice = parseFloat(document.getElementById("currentPrice").value) || 0;
      const entry1 = parseFloat(document.getElementById("entryPrice").value) || 0;
      const sl1 = parseFloat(document.getElementById("slPrice").value) || 0;
      let tp1 = parseFloat(document.getElementById("tpPrice").value) || 0;
      const rrTarget = parseFloat(document.getElementById("rrInput").value);
      const lotTotal = parseFloat(document.getElementById("lotTotal").value) || 0;
      const count = parseInt(document.getElementById("positionCount").value, 10) || 1;

      if(!isNaN(rrTarget) && rrTarget > 0 && entry1 > 0 && sl1 > 0){
        let riskDist = 0;
        if(side === "buy") riskDist = entry1 - sl1;
        else riskDist = sl1 - entry1;
        if(riskDist > 0){
          const rewardDist = riskDist * rrTarget;
          let tpAuto = 0;
          if(side === "buy") tpAuto = entry1 + rewardDist;
          else tpAuto = entry1 - rewardDist;
          tp1 = tpAuto;
          document.getElementById("tpPrice").value = tp1.toFixed(2);
        }
      }

      recalcLotPctFromInputs();

      let p1 = parseFloat(document.getElementById("lotPct1").value) || 0;
      let p2 = parseFloat(document.getElementById("lotPct2").value) || 0;
      let p3 = parseFloat(document.getElementById("lotPct3").value) || 0;
      if(count === 1){
        p1 = 100; p2 = 0; p3 = 0;
        document.getElementById("lotPct1").value = 100;
        document.getElementById("lotPct2").value = 0;
        document.getElementById("lotPct3").value = 0;
      }

      const lot1 = lotTotal * (p1 / 100);
      const lot2 = lotTotal * (p2 / 100);
      const lot3 = lotTotal * (p3 / 100);

      document.getElementById("lot1Disp").textContent = formatNumber(lot1,3);
      document.getElementById("lot2Disp").textContent = formatNumber(lot2,3);
      document.getElementById("lot3Disp").textContent = formatNumber(lot3,3);

      const riskTotal = balance * (riskPct / 100);
      let riskUsedSoFar = 0;

      function buildOrder(index, lot){
        let entry, sl, tp;
        if(index === 1){
          entry = entry1; sl = sl1; tp = tp1;
        } else {
          entry = parseFloat(document.getElementById("entryPrice" + index).value) || 0;
          sl = parseFloat(document.getElementById("slPrice" + index).value) || 0;
          tp = parseFloat(document.getElementById("tpPrice" + index).value) || 0;
          const autoEl = document.getElementById("autoEntry" + index);
          const isAuto = autoEl && autoEl.checked;

          if(isAuto && lot > 0 && sl !== 0){
            const riskRemaining = riskTotal - riskUsedSoFar;
            if(riskRemaining > 0){
              const unitsTmp = contractSize * lot;
              const distance = riskRemaining / unitsTmp;
              if(side === "buy") entry = sl + distance;
              else entry = sl - distance;
              document.getElementById("entryPrice" + index).value = entry.toFixed(2);
            }
          }
        }

        const units = contractSize * lot;
        let margin = 0, plNow = 0, slPL = 0, tpPL = 0;

        if(entry > 0 && units > 0){
          margin = units * entry / leverage;

          const plPerUnitNow = (side === "buy")
            ? (currentPrice - entry)
            : (entry - currentPrice);
          plNow = plPerUnitNow * units;

          if(sl !== 0){
            const plPerUnitSL = (side === "buy")
              ? (sl - entry)
              : (entry - sl);
            slPL = plPerUnitSL * units;
          }
          if(tp !== 0){
            const plPerUnitTP = (side === "buy")
              ? (tp - entry)
              : (entry - tp);
            tpPL = plPerUnitTP * units;
          }
        }

        riskUsedSoFar += Math.abs(slPL);
        return { margin, plNow, slPL, tpPL, units };
      }

      const orders = [];
      if(lot1 > 0) orders.push(buildOrder(1, lot1));
      if(count >= 2 && lot2 > 0) orders.push(buildOrder(2, lot2));
      if(count === 3 && lot3 > 0) orders.push(buildOrder(3, lot3));

      let totalMargin=0, totalPLNow=0, totalSLPL=0, totalTPPL=0, totalUnits=0;
      orders.forEach(o => {
        totalMargin += o.margin;
        totalPLNow += o.plNow;
        totalSLPL += o.slPL;
        totalTPPL += o.tpPL;
        totalUnits += o.units;
      });

      document.getElementById("riskAmount").textContent = formatMoney(riskTotal);

      const marginEl = document.getElementById("marginRequired");
      const plEl = document.getElementById("currentPL");
      const slPLEl = document.getElementById("slPL");
      const tpPLEl = document.getElementById("tpPL");
      const rrEl = document.getElementById("rrRatio");

      marginEl.textContent = formatMoney(totalMargin);

      plEl.textContent = formatMoney(totalPLNow);
      plEl.className = "result-value " +
        (totalPLNow > 0 ? "positive" : totalPLNow < 0 ? "negative" : "");

      slPLEl.textContent = formatMoney(totalSLPL);
      slPLEl.className = "result-value " +
        (totalSLPL > 0 ? "positive" : totalSLPL < 0 ? "negative" : "");

      tpPLEl.textContent = formatMoney(totalTPPL);
      tpPLEl.className = "result-value " +
        (totalTPPL > 0 ? "positive" : totalTPPL < 0 ? "negative" : "");

      const riskValue = Math.abs(totalSLPL);
      const rewardValue = Math.abs(totalTPPL);
      let rrText = "1 : 0.00";
      if(riskValue > 0){
        const rr = rewardValue / riskValue;
        rrText = "1 : " + formatNumber(rr,2);
      }
      rrEl.textContent = rrText;

      const equityNow = balance + totalPLNow;
      const equityAtCall = totalMargin * (marginCallPct / 100);
      const maxLossFromNow = equityNow - equityAtCall;
      const priceMoveToCall = totalUnits > 0
        ? maxLossFromNow / totalUnits
        : 0;

      let marginCallPrice = 0;
      if(side === "buy") marginCallPrice = currentPrice - priceMoveToCall;
      else marginCallPrice = currentPrice + priceMoveToCall;

      document.getElementById("priceMove").textContent = formatNumber(priceMoveToCall,3);
      document.getElementById("marginCallPrice").textContent = formatNumber(marginCallPrice,2);

      function setPos(idx, o){
        const margin = o ? o.margin : 0;
        const plNow = o ? o.plNow : 0;
        const slPL = o ? o.slPL : 0;
        const tpPL = o ? o.tpPL : 0;

        document.getElementById("margin" + idx).textContent = formatMoney(margin);

        const plNowEl = document.getElementById("pl" + idx);
        const slEl = document.getElementById("sl" + idx);
        const tpEl = document.getElementById("tp" + idx);

        plNowEl.textContent = formatMoney(plNow);
        plNowEl.className = "result-value " +
          (plNow > 0 ? "positive" : plNow < 0 ? "negative" : "");

        slEl.textContent = formatMoney(slPL);
        slEl.className = "result-value " +
          (slPL > 0 ? "positive" : slPL < 0 ? "negative" : "");

        tpEl.textContent = formatMoney(tpPL);
        tpEl.className = "result-value " +
          (tpPL > 0 ? "positive" : tpPL < 0 ? "negative" : "");

        const rrElPos = document.getElementById("rr" + idx);
        const riskV = Math.abs(slPL);
        const rewardV = Math.abs(tpPL);
        let txt = "1 : 0.00";
        if(riskV > 0){
          const r = rewardV / riskV;
          txt = "1 : " + formatNumber(r,2);
        }
        rrElPos.textContent = txt;
      }

      setPos(1, orders[0] || null);
      setPos(2, orders[1] || null);
      setPos(3, orders[2] || null);

      saveSettings();
    }

    function resetAll(){
      const ids = [
        "symbol","entryPrice","currentPrice","slPrice","tpPrice","rrInput",
        "entryPrice2","slPrice2","tpPrice2",
        "entryPrice3","slPrice3","tpPrice3"
      ];
      ids.forEach(id => {
        const el = document.getElementById(id);
        if(el) el.value = "";
      });

      document.getElementById("balance").value = 1500;
      document.getElementById("riskPct").value = 1;
      document.getElementById("leverage").value = 1000;
      document.getElementById("marginCall").value = 100;
      document.getElementById("contractSize").value = 100;
      document.getElementById("lotTotal").value = 0.50;
      document.getElementById("positionCount").value = "1";
      document.getElementById("lotPct1").value = 100;
      document.getElementById("lotPct2").value = 0;
      document.getElementById("lotPct3").value = 0;
      document.getElementById("autoEntry2").checked = false;
      document.getElementById("autoEntry3").checked = false;
      document.getElementById("suggestedLot").textContent = "0.00";

      try { localStorage.removeItem(STORAGE_KEY); } catch(e){}

      applySplitVisibility();
      recalcLotPctFromInputs();
      applyAutoEntryState(2);
      applyAutoEntryState(3);
      updatePositionTitle();
      calculate();
    }

    document.addEventListener("DOMContentLoaded", function(){
      loadSettings();

      const themeToggle = document.getElementById("themeToggle");
      themeToggle.addEventListener("click", toggleTheme);

      document.getElementById("positionCount").addEventListener("change", function(){
        applySplitVisibility();
        recalcLotPctFromInputs();
        saveSettings();
        calculate();
      });

      document.getElementById("lotPct2").addEventListener("input", function(){
        recalcLotPctFromInputs("lotPct2");
        saveSettings();
        calculate();
      });
      document.getElementById("lotPct3").addEventListener("input", function(){
        recalcLotPctFromInputs("lotPct3");
        saveSettings();
        calculate();
      });

      document.getElementById("autoEntry2").addEventListener("change", function(){
        applyAutoEntryState(2);
        saveSettings();
        calculate();
      });
      document.getElementById("autoEntry3").addEventListener("change", function(){
        applyAutoEntryState(3);
        saveSettings();
        calculate();
      });

      document.querySelectorAll("input, select").forEach(el => {
        el.addEventListener("input", function(){
          if(el.id === "symbol") maybeApplyContractPreset();
          saveSettings();
          calculate();
        });
      });

      document.querySelectorAll('input[name="side"]').forEach(el => {
        el.addEventListener("change", function(){
          saveSettings();
          calculate();
        });
      });

      maybeApplyContractPreset();
      updatePositionTitle();
      calculate();
    });
  </script>
</body>
</html>
